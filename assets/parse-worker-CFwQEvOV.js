(function(){"use strict";const T=Array.from({length:256},(i,e)=>e.toString(16).padStart(2,"0").toUpperCase()),l={ATTRIBUTE:6,CDATA_SECTION:7,CHAR_REF:8,CLOSE_EMPTY_ELEMENT:3,CLOSE_START_ELEMENT:2,END_ELEMENT:4,ENTITY_REF:9,EOF:0,FRAGMENT_HEADER:15,HAS_MORE_DATA_FLAG:64,NORMAL_SUBSTITUTION:13,OPEN_START_ELEMENT:1,OPTIONAL_SUBSTITUTION:14,PI_DATA:11,PI_TARGET:10,TEMPLATE_INSTANCE:12,VALUE:5},M={0:"EOF",1:"OpenStartElement",2:"CloseStartElement",3:"CloseEmptyElement",4:"EndElement",5:"Value",6:"Attribute",7:"CDATASection",8:"CharRef",9:"EntityRef",10:"PITarget",11:"PIData",12:"TemplateInstance",13:"NormalSubstitution",14:"OptionalSubstitution",15:"FragmentHeader"},h={ANSI_STRING:2,BINARY:14,BINXML:33,BOOL:13,DOUBLE:12,FILETIME:17,FLOAT:11,GUID:15,HEX32:20,HEX64:21,INT16:5,INT32:7,INT64:9,INT8:3,NULL:0,SID:19,SIZE:16,STRING:1,SYSTEMTIME:18,UINT16:6,UINT32:8,UINT64:10,UINT8:4};new TextDecoder("utf-16le");function _(i){return`0x${i.toString(16).padStart(8,"0")}`}function R(i){return i.indexOf("&")===-1&&i.indexOf("<")===-1&&i.indexOf(">")===-1&&i.indexOf('"')===-1&&i.indexOf("'")===-1?i:i.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&apos;")}function k(i){const e=i&-65;let r=M[e]??`Unknown_0x${T[i]??"??"}`;return i&l.HAS_MORE_DATA_FLAG&&(r+="+MoreData"),r}function C(i){const e=(i[3]<<24|i[2]<<16|i[1]<<8|i[0])>>>0,r=i[5]<<8|i[4],t=i[7]<<8|i[6];return"{"+e.toString(16).padStart(8,"0")+"-"+r.toString(16).padStart(4,"0")+"-"+t.toString(16).padStart(4,"0")+"-"+T[i[8]]+T[i[9]]+T[i[10]]+T[i[11]]+"-"+T[i[12]]+T[i[13]]+T[i[14]]+T[i[15]]+"}"}const $=new Uint8Array(0);class D{static utf16=new TextDecoder("utf-16le");static ascii=new TextDecoder("ascii");chunkDv;chunkHeader;tplStats;chunkStart;constructor(e,r,t){this.chunkDv=e,this.chunkHeader=r,this.tplStats=t,this.chunkStart=r?r.chunkStart:0}readName(e){const r=this.chunkDv.getUint16(e+6,!0),t=new Uint8Array(this.chunkDv.buffer,this.chunkDv.byteOffset+e+8,r*2);return D.utf16.decode(t)}readUnicodeTextString(e,r,t){const s=e.getUint16(t.offset,!0);t.offset+=2;const n=new Uint8Array(r.buffer,r.byteOffset+t.offset,s*2);return t.offset+=s*2,D.utf16.decode(n)}renderSubstitutionValue(e,r){if(e.length===0)return"";if(r&128){const s=r&127;if(s===h.STRING){const o=D.utf16.decode(e).split("\0").filter(c=>c.length>0);return R(o.join(", "))}let n=0;if(s===h.INT8||s===h.UINT8?n=1:s===h.INT16||s===h.UINT16?n=2:s===h.INT32||s===h.UINT32||s===h.FLOAT||s===h.HEX32?n=4:s===h.INT64||s===h.UINT64||s===h.DOUBLE||s===h.FILETIME||s===h.HEX64?n=8:(s===h.GUID||s===h.SYSTEMTIME)&&(n=16),n>0&&e.length>=n){const a=[];for(let o=0;o+n<=e.length;o+=n){const c=new Uint8Array(e.buffer,e.byteOffset+o,n);a.push(this.renderSubstitutionValue(c,s))}return a.join(", ")}let f="";for(let a=0;a<e.length;a++)f+=T[e[a]];return f}const t=e.byteOffset-this.chunkDv.byteOffset;switch(r){case h.NULL:return"";case h.STRING:{let s=D.utf16.decode(e);return s.endsWith("\0")&&(s=s.slice(0,-1)),R(s)}case h.ANSI_STRING:{let s=D.ascii.decode(e);return s.endsWith("\0")&&(s=s.slice(0,-1)),R(s)}case h.INT8:return String(this.chunkDv.getInt8(t));case h.UINT8:return String(this.chunkDv.getUint8(t));case h.INT16:return String(this.chunkDv.getInt16(t,!0));case h.UINT16:return String(this.chunkDv.getUint16(t,!0));case h.INT32:return String(this.chunkDv.getInt32(t,!0));case h.UINT32:return String(this.chunkDv.getUint32(t,!0));case h.INT64:return String(this.chunkDv.getBigInt64(t,!0));case h.UINT64:return String(this.chunkDv.getBigUint64(t,!0));case h.FLOAT:return String(this.chunkDv.getFloat32(t,!0));case h.DOUBLE:return String(this.chunkDv.getFloat64(t,!0));case h.BOOL:return this.chunkDv.getUint32(t,!0)?"true":"false";case h.BINARY:{let s="";for(let n=0;n<e.length;n++)s+=T[e[n]];return s}case h.GUID:{if(e.length<16)return"";const s=this.chunkDv.getUint32(t,!0).toString(16).padStart(8,"0"),n=this.chunkDv.getUint16(t+4,!0).toString(16).padStart(4,"0"),f=this.chunkDv.getUint16(t+6,!0).toString(16).padStart(4,"0");return"{"+s+"-"+n+"-"+f+"-"+T[e[8]]+T[e[9]]+T[e[10]]+T[e[11]]+"-"+T[e[12]]+T[e[13]]+T[e[14]]+T[e[15]]+"}"}case h.SIZE:return e.length===8?`0x${this.chunkDv.getBigUint64(t,!0).toString(16).padStart(16,"0")}`:`0x${this.chunkDv.getUint32(t,!0).toString(16).padStart(8,"0")}`;case h.FILETIME:{if(e.length<8)return"";const s=this.chunkDv.getBigUint64(t,!0);if(s===0n)return"";const n=Number(s/10000n-11644473600000n),f=new Date(n);return Number.isNaN(f.getTime())?"":`${f.toISOString().slice(0,19)}.${String(Number(s%10000000n)).padStart(7,"0")}Z`}case h.SYSTEMTIME:{if(e.length<16)return"";const s=this.chunkDv.getUint16(t,!0),n=this.chunkDv.getUint16(t+2,!0),f=this.chunkDv.getUint16(t+6,!0),a=this.chunkDv.getUint16(t+8,!0),o=this.chunkDv.getUint16(t+10,!0),c=this.chunkDv.getUint16(t+12,!0),u=this.chunkDv.getUint16(t+14,!0);return`${s}-${String(n).padStart(2,"0")}-${String(f).padStart(2,"0")}T${String(a).padStart(2,"0")}:${String(o).padStart(2,"0")}:${String(c).padStart(2,"0")}.${String(u).padStart(3,"0")}Z`}case h.SID:{if(e.length<8)return"";const s=e[0],n=e[1];let f=0;for(let o=2;o<8;o++)f=f*256+e[o];let a=`S-${s}-${f}`;for(let o=0;o<n&&!(8+o*4+4>e.length);o++)a+="-"+this.chunkDv.getUint32(t+8+o*4,!0);return a}case h.HEX32:return`0x${this.chunkDv.getUint32(t,!0).toString(16).padStart(8,"0")}`;case h.HEX64:return`0x${this.chunkDv.getBigUint64(t,!0).toString(16).padStart(16,"0")}`;case h.BINXML:{const s=e.byteOffset-this.chunkDv.byteOffset;return this.parseDocument(e,s)}default:{let s="";for(let n=0;n<e.length;n++)s+=T[e[n]];return"<!-- unknown value type 0x"+(T[r]??"??")+" -->"+s}}}compileTemplate(e,r,t){const s={parts:[""],subIds:[],isOptional:[],bail:!1},n={offset:0};return e.length>=4&&e[0]===l.FRAGMENT_HEADER&&(n.offset+=4),this.compileContent(e,r,n,t,s),s.bail?null:{parts:s.parts,subIds:s.subIds,isOptional:s.isOptional}}compileContent(e,r,t,s,n){for(;t.offset<e.length;){if(n.bail)return;const a=(e[t.offset]??0)&-65;if(a===l.EOF||a===l.CLOSE_START_ELEMENT||a===l.CLOSE_EMPTY_ELEMENT||a===l.END_ELEMENT||a===l.ATTRIBUTE)break;if(a===l.OPEN_START_ELEMENT)this.compileElement(e,r,t,s,n);else if(a===l.VALUE){t.offset++,t.offset++;const o=this.readUnicodeTextString(r,e,t);n.parts[n.parts.length-1]+=R(o)}else if(a===l.NORMAL_SUBSTITUTION){t.offset++;const o=r.getUint16(t.offset,!0);t.offset+=2,t.offset++,n.subIds.push(o),n.isOptional.push(!1),n.parts.push("")}else if(a===l.OPTIONAL_SUBSTITUTION){t.offset++;const o=r.getUint16(t.offset,!0);t.offset+=2,t.offset++,n.subIds.push(o),n.isOptional.push(!0),n.parts.push("")}else if(a===l.CHAR_REF){t.offset++;const o=r.getUint16(t.offset,!0);t.offset+=2,n.parts[n.parts.length-1]+="&#"+o+";"}else if(a===l.ENTITY_REF){t.offset++;const o=r.getUint32(t.offset,!0);t.offset+=4;const c=this.readName(o);n.parts[n.parts.length-1]+="&"+c+";"}else if(a===l.CDATA_SECTION){t.offset++;const o=this.readUnicodeTextString(r,e,t);n.parts[n.parts.length-1]+="<![CDATA["+o+"]]>"}else if(a===l.TEMPLATE_INSTANCE||a===l.FRAGMENT_HEADER){n.bail=!0;return}else{n.bail=!0;return}}}compileElement(e,r,t,s,n){const a=!!((e[t.offset]??0)&l.HAS_MORE_DATA_FLAG);t.offset++,t.offset+=2,t.offset+=4;const o=r.getUint32(t.offset,!0);if(t.offset+=4,o===s+t.offset){const d=r.getUint16(t.offset+6,!0);t.offset+=10+d*2}const c=this.readName(o);if(n.parts[n.parts.length-1]+="<"+c,a){const d=r.getUint32(t.offset,!0);t.offset+=4;const S=t.offset+d;for(;t.offset<S;){if(n.bail)return;if(((e[t.offset]??0)&-65)!==l.ATTRIBUTE)break;t.offset++;const E=r.getUint32(t.offset,!0);if(t.offset+=4,E===s+t.offset){const I=r.getUint16(t.offset+6,!0);t.offset+=10+I*2}const g=this.readName(E);if(n.parts[n.parts.length-1]+=" "+g+'="',this.compileContent(e,r,t,s,n),n.bail)return;n.parts[n.parts.length-1]+='"'}}if(t.offset>=e.length){n.parts[n.parts.length-1]+="/>";return}const u=e[t.offset]??0;if(u===l.CLOSE_EMPTY_ELEMENT)t.offset++,n.parts[n.parts.length-1]+="/>";else if(u===l.CLOSE_START_ELEMENT){if(t.offset++,n.parts[n.parts.length-1]+=">",this.compileContent(e,r,t,s,n),n.bail)return;t.offset<e.length&&e[t.offset]===l.END_ELEMENT&&t.offset++,n.parts[n.parts.length-1]+="</"+c+">"}else n.parts[n.parts.length-1]+="><!-- UNEXPECTED close token 0x"+(T[u]??"??")+" --></"+c+">"}renderCompiled(e,r){const{parts:t,subIds:s,isOptional:n}=e;let f=t[0];for(let a=0;a<s.length;a++){const o=s[a];if(o<r.length){const c=r[o];(!n[a]||c.type!==h.NULL&&c.size>0)&&(c.rendered===null&&(c.rendered=this.renderSubstitutionValue(c.bytes,c.type)),f+=c.rendered)}f+=t[a+1]}return f}parseContent(e,r,t,s,n){let f="";for(;t.offset<e.length;){const a=e[t.offset]??0,o=a&-65;if(o===l.EOF||o===l.CLOSE_START_ELEMENT||o===l.CLOSE_EMPTY_ELEMENT||o===l.END_ELEMENT||o===l.ATTRIBUTE)break;if(o===l.OPEN_START_ELEMENT)f+=this.parseElement(e,r,t,s,n);else if(o===l.VALUE){t.offset++,t.offset++;const c=this.readUnicodeTextString(r,e,t);f+=R(c)}else if(o===l.NORMAL_SUBSTITUTION){t.offset++;const c=r.getUint16(t.offset,!0);if(t.offset+=2,t.offset++,s&&c<s.length){const u=s[c];u.rendered===null&&(u.rendered=this.renderSubstitutionValue(u.bytes,u.type)),f+=u.rendered}}else if(o===l.OPTIONAL_SUBSTITUTION){t.offset++;const c=r.getUint16(t.offset,!0);if(t.offset+=2,t.offset++,s&&c<s.length){const u=s[c];u.type!==h.NULL&&u.size>0&&(u.rendered===null&&(u.rendered=this.renderSubstitutionValue(u.bytes,u.type)),f+=u.rendered)}}else if(o===l.CHAR_REF){t.offset++;const c=r.getUint16(t.offset,!0);t.offset+=2,f+="&#"+c+";"}else if(o===l.ENTITY_REF){t.offset++;const c=r.getUint32(t.offset,!0);t.offset+=4;const u=this.readName(c);f+="&"+u+";"}else if(o===l.CDATA_SECTION){t.offset++;const c=this.readUnicodeTextString(r,e,t);f+="<![CDATA["+c+"]]>"}else o===l.TEMPLATE_INSTANCE?f+=this.parseTemplateInstance(e,r,t,n):o===l.FRAGMENT_HEADER?f+=this.parseFragment(e,r,t,n):(f+="<!-- UNEXPECTED content token 0x"+(T[a]??"??")+" ("+k(a)+") at offset "+t.offset+" -->",t.offset++)}return f}parseElement(e,r,t,s,n){const a=!!((e[t.offset]??0)&l.HAS_MORE_DATA_FLAG);t.offset++,t.offset+=2,t.offset+=4;const o=r.getUint32(t.offset,!0);if(t.offset+=4,o===n+t.offset){const S=r.getUint16(t.offset+6,!0);t.offset+=10+S*2}const c=this.readName(o);let u="<"+c;if(a){const S=r.getUint32(t.offset,!0);t.offset+=4;const U=t.offset+S;for(;t.offset<U&&((e[t.offset]??0)&-65)===l.ATTRIBUTE;){t.offset++;const g=r.getUint32(t.offset,!0);if(t.offset+=4,g===n+t.offset){const m=r.getUint16(t.offset+6,!0);t.offset+=10+m*2}const I=this.readName(g),N=this.parseContent(e,r,t,s,n);u+=" "+I+'="'+N+'"'}}if(t.offset>=e.length)return u+"/>";const d=e[t.offset]??0;return d===l.CLOSE_EMPTY_ELEMENT?(t.offset++,u+"/>"):d===l.CLOSE_START_ELEMENT?(t.offset++,u+=">",u+=this.parseContent(e,r,t,s,n),t.offset<e.length&&e[t.offset]===l.END_ELEMENT&&t.offset++,u+"</"+c+">"):u+"><!-- UNEXPECTED close token 0x"+(T[d]??"??")+" --></"+c+">"}parseTemplateInstance(e,r,t,s){t.offset++,t.offset++,t.offset+=4;const n=r.getUint32(t.offset,!0);t.offset+=4;const f=s+t.offset,a=n===f;let o="",c=0;if(a){t.offset+=4;const E=new Uint8Array(e.buffer,e.byteOffset+t.offset,16);o=C(E),t.offset+=16,c=r.getUint32(t.offset,!0),t.offset+=4,this.tplStats&&(this.tplStats.defsByOffset[n]||(this.tplStats.defsByOffset[n]={guid:o,defDataOffset:n,dataSize:c,firstSeenRecord:this.tplStats.currentRecordId}),this.tplStats.definitions[o]||(this.tplStats.definitions[o]=this.tplStats.defsByOffset[n],this.tplStats.definitionCount++)),t.offset+=c}else{const E=this.tplStats.defsByOffset[n];if(E)o=E.guid,c=E.dataSize;else if(n+24<=this.chunkDv.byteLength){const g=new Uint8Array(this.chunkDv.buffer,this.chunkDv.byteOffset+n+4,16);o=C(g),c=this.chunkDv.getUint32(n+20,!0),this.tplStats.defsByOffset[n]={guid:o,defDataOffset:n,dataSize:c,firstSeenRecord:this.tplStats.currentRecordId},this.tplStats.definitions[o]||(this.tplStats.definitions[o]=this.tplStats.defsByOffset[n],this.tplStats.definitionCount++)}}this.tplStats&&(this.tplStats.references.push({recordId:this.tplStats.currentRecordId,guid:o,defDataOffset:n,dataSize:c,isInline:a}),this.tplStats.referenceCount++);const u=r.getUint32(t.offset,!0);t.offset+=4;const d=t.offset;t.offset+=u*4;const S=[];for(let E=0;E<u;E++){const g=d+E*4,I=r.getUint16(g,!0),N=e[g+2]??0;let m;I>0&&t.offset+I<=e.length?m=new Uint8Array(e.buffer,e.byteOffset+t.offset,I):m=$,t.offset+=I,S.push({type:N,size:I,bytes:m,rendered:null})}let U=!0,p="";try{if(c===0)throw U=!1,new Error(`no template definition found for defOffset=${_(n)}`);const E=n+24;if(E+c>this.chunkDv.byteLength)throw U=!1,new Error(`template def offset ${_(n)} + size ${c} exceeds chunk`);const g=new Uint8Array(this.chunkDv.buffer,this.chunkDv.byteOffset+E,c),I=new DataView(g.buffer,g.byteOffset,g.byteLength);let N=this.tplStats.compiled.get(o);if(N===void 0&&(N=this.compileTemplate(g,I,E),this.tplStats.compiled.set(o,N)),N!==null)p=this.renderCompiled(N,S);else{const m={offset:0};g.length>=4&&g[0]===l.FRAGMENT_HEADER&&(m.offset+=4),p=this.parseContent(g,I,m,S,E)}}catch(E){p=`<!-- template parse error: ${E instanceof Error?E.message:String(E)} -->`,U=!1}return this.tplStats&&!U&&(this.tplStats.missingRefs.push({recordId:this.tplStats.currentRecordId,guid:o||"(unknown)",defDataOffset:n}),this.tplStats.missingCount++),p}parseDocument(e,r){const t={offset:0},s=new DataView(e.buffer,e.byteOffset,e.byteLength);let n="";for(;t.offset<e.length;){const f=e[t.offset]??0,a=f&-65;if(a===l.EOF)break;if(a===l.FRAGMENT_HEADER)n+=this.parseFragment(e,s,t,r);else if(a===l.PI_TARGET){t.offset++;const o=s.getUint32(t.offset,!0);t.offset+=4;let u="<?"+this.readName(o);if(t.offset<e.length&&e[t.offset]===l.PI_DATA){t.offset++;const d=this.readUnicodeTextString(s,e,t);d&&(u+=" "+d)}n+=u+"?>"}else{n+="<!-- UNEXPECTED document token 0x"+(T[f]??"??")+" ("+k(f)+") at offset "+t.offset+" -->";break}}return n}parseFragment(e,r,t,s){if(t.offset+4>e.length)return`<!-- TRUNCATED fragment header at offset ${t.offset} -->
`;if(t.offset+=4,t.offset>=e.length)return`<!-- TRUNCATED after fragment header -->
`;const n=e[t.offset]??0,f=n&-65;return f===l.TEMPLATE_INSTANCE?this.parseTemplateInstance(e,r,t,s):f===l.OPEN_START_ELEMENT?this.parseElement(e,r,t,null,s):"<!-- UNEXPECTED post-fragment token 0x"+(T[n]??"??")+" ("+k(n)+") at offset "+t.offset+` -->
`}}const F={eventId:"",level:0,provider:"",computer:"",channel:"",task:"",opcode:"",keywords:"",version:"",processId:"",threadId:"",securityUserId:"",activityId:"",relatedActivityId:"",eventData:""};function A(i,e,r=0){const t="<"+e,s=t.length;let n=r;for(;;){if(n=i.indexOf(t,n),n===-1)return"";const o=i.charCodeAt(n+s);if(o===62||o===32||o===47||o===9||o===10||o===13)break;n+=s}const f=i.indexOf(">",n+s);if(f===-1||i.charCodeAt(f-1)===47)return"";const a=i.indexOf("</"+e+">",f+1);return a===-1?"":i.substring(f+1,a)}function L(i,e,r,t=0){const s="<"+e,n=s.length;let f=t;for(;;){if(f=i.indexOf(s,f),f===-1)return"";const S=i.charCodeAt(f+n);if(S===62||S===32||S===47||S===9||S===10||S===13)break;f+=n}const a=i.indexOf(">",f);if(a===-1)return"";const o=r+'="',c=i.indexOf(o,f+n);if(c===-1||c>=a)return"";const u=c+o.length,d=i.indexOf('"',u);return d===-1||d>a?"":i.substring(u,d)}function O(i){return i.indexOf("&")===-1?i:i.replaceAll("&lt;","<").replaceAll("&gt;",">").replaceAll("&quot;",'"').replaceAll("&apos;","'").replaceAll("&amp;","&")}function x(i){const e=[];let r=0;for(;;){const t=i.indexOf("<Data",r);if(t===-1)break;const s=i.indexOf(">",t+5);if(s===-1)break;if(i.charCodeAt(s-1)===47){r=s+1;continue}const n=i.indexOf("</Data>",s+1);if(n===-1)break;const f=i.substring(s+1,n);if(f){const a=i.indexOf('Name="',t+5);if(a!==-1&&a<s){const o=a+6,c=i.indexOf('"',o);c!==-1&&c<s?e.push(i.substring(o,c)+": "+O(f)):e.push(O(f))}else e.push(O(f))}r=n+7}return e.join(`
`)}function w(i){const e=[];let r=0;for(;r<i.length;){const t=i.indexOf("<",r);if(t===-1)break;const s=i.charCodeAt(t+1);if(s===47||s===33||s===63){const d=i.indexOf(">",t+2);r=d===-1?i.length:d+1;continue}let n=t+1;for(;n<i.length;){const d=i.charCodeAt(n);if(d===32||d===62||d===47||d===9||d===10||d===13)break;n++}const f=i.substring(t+1,n),a=i.indexOf(">",t);if(a===-1)break;if(i.charCodeAt(a-1)===47){r=a+1;continue}const o="</"+f+">",c=i.indexOf(o,a+1);if(c===-1){r=a+1;continue}const u=i.substring(a+1,c);if(u.indexOf("<")===-1){const d=u.trim();d&&e.push(f+": "+O(d))}r=a+1}return e.join(`
`)}function y(i){if(!i)return{...F};const e=O(A(i,"EventID")),r=A(i,"Level"),t=r&&parseInt(r,10)||0,s=O(L(i,"Provider","Name")),n=O(A(i,"Computer")),f=O(A(i,"Channel")),a=A(i,"Task"),o=A(i,"Opcode"),c=A(i,"Keywords"),u=A(i,"Version"),d=L(i,"Execution","ProcessID"),S=L(i,"Execution","ThreadID"),U=L(i,"Security","UserID"),p=L(i,"Correlation","ActivityID"),E=L(i,"Correlation","RelatedActivityID");let g="";const I=A(i,"EventData");if(I&&(I.indexOf("<Data")!==-1&&(g=x(I)),!g&&I.indexOf("<")!==-1&&(g=w(I)),!g)){const N=I.trim();N&&(g=O(N))}if(!g){const N=A(i,"UserData");N&&(g=w(N))}if(!g){const N=A(i,"RenderingInfo");if(N){const m=A(N,"Message");m&&(g=O(m))}}return{eventId:e,level:t,provider:s,computer:n,channel:f,task:a,opcode:o,keywords:c,version:u,processId:d,threadId:S,securityUserId:U,activityId:p,relatedActivityId:E,eventData:g}}const P={1:"Critical",2:"Error",3:"Warning",4:"Information",5:"Verbose"};function H(i,e){const r=i.getBigUint64(e,!0);if(r===0n)return"";const t=Number(r/10000n-11644473600000n),s=new Date(t);return Number.isNaN(s.getTime())?"":`${s.toISOString().slice(0,19)}.${String(Number(r%10000000n)).padStart(7,"0")}Z`}function V(i,e){if(e??=new DataView(i,0,124),e.getUint32(0,!1)!==1164731974||e.getUint16(4,!1)!==26988||e.getUint8(6)!==101)throw new Error("Not a valid EVTX file");const r=e.getUint16(40,!0),t=e.getUint32(120,!0);return{headerBlockSize:r,flags:t,isDirty:(t&1)!==0,isFull:(t&2)!==0}}function z(i,e,r){const t=new Uint32Array(64);for(let n=0;n<64;n++)t[n]=e.getUint32(r+128+n*4,!0);const s=new Uint32Array(32);for(let n=0;n<32;n++)s[n]=e.getUint32(r+384+n*4,!0);return{chunkStart:r,firstEventRecordNumber:Number(e.getBigUint64(r+8,!0)),lastEventRecordNumber:Number(e.getBigUint64(r+16,!0)),firstEventRecordId:Number(e.getBigUint64(r+24,!0)),lastEventRecordId:Number(e.getBigUint64(r+32,!0)),headerSize:e.getUint32(r+40,!0),lastEventRecordOffset:r+e.getUint32(r+44,!0),freeSpaceOffset:r+e.getUint32(r+48,!0),eventRecordsChecksum:e.getUint32(r+52,!0),flags:e.getUint32(r+120,!0),headerChecksum:e.getUint32(r+124,!0),commonStringOffsets:t,templatePointers:s,recordsStart:r+512,chunkEnd:r+65536}}function B(i,e,r,t,s){if(r+28>s||e.getUint32(r,!0)!==10794)return null;const f=e.getUint32(r+4,!0);if(f<28||r+f>s)return null;const a=e.getUint32(r+f-4,!0);return{fileOffset:r,chunkOffset:r-t,recordId:Number(e.getBigUint64(r+8,!0)),timestamp:H(e,r+16),size:f,sizeCopy:a,sizeMatch:f===a,binxmlLength:f-28,binxmlBytes:new Uint8Array(i,r+24,f-28),binxmlFirstByte:f>28?e.getUint8(r+24):null,recordSize:f}}function G(i,e,r){const t=[];e.flags&1&&t.push(`Chunk ${i}: has dirty/corrupted flag (0x01) — often benign, e.g. unclean shutdown`);const s=e.lastEventRecordId-e.firstEventRecordId+1;r.length!==s&&t.push(`Chunk ${i}: expected ${s} records (IDs ${e.firstEventRecordId}..${e.lastEventRecordId}), found ${r.length}`);for(let n=1;n<r.length;n++){const f=r[n],a=r[n-1];f&&a&&f.recordId!==a.recordId+1&&t.push(`Chunk ${i}, record ${f.recordId}: non-sequential ID (previous was ${a.recordId})`)}for(let n=0;n<r.length;n++){const f=r[n];f&&(f.sizeMatch||t.push(`Record ${f.recordId}: size mismatch — header says ${f.size}, trailing copy says ${f.sizeCopy}`),f.binxmlFirstByte!==null&&f.binxmlFirstByte!==15&&t.push(`Record ${f.recordId}: BinXml starts with 0x${T[f.binxmlFirstByte]??"??"} instead of 0x0F (FragmentHeader)`),f.binxmlLength===0&&t.push(`Record ${f.recordId}: empty BinXml payload (0 bytes)`),f.binxmlLength>0&&f.binxmlLength<4&&t.push(`Record ${f.recordId}: BinXml payload suspiciously small (${f.binxmlLength} bytes)`),f.timestamp||t.push(`Record ${f.recordId}: missing or zero timestamp`))}return t}function X(i,e,r){const t=z(i,e,r),s=[];let n=t.recordsStart;for(;n<t.freeSpaceOffset;){const f=B(i,e,n,r,t.chunkEnd);if(!f)break;s.push(f),n+=f.recordSize}return{header:t,records:s}}function Y(i,e){const r=[];let t=e;for(;t+65536<=i.byteLength;)i.getUint32(t,!1)===1164731971&&i.getUint16(t+4,!1)===26734&&i.getUint8(t+6)===107&&r.push(t),t+=65536;return r}function b(i,e,r){for(let t=0;t<e.templatePointers.length;t++){let s=e.templatePointers[t];for(;s!==0&&s!==void 0&&!r.defsByOffset[s];)try{if(s+24>65536)break;const n=i.getUint32(s,!0),f=new Uint8Array(i.buffer,i.byteOffset+s+4,16),a=C(f),o=i.getUint32(s+20,!0);r.defsByOffset[s]={guid:a,defDataOffset:s,dataSize:o,firstSeenRecord:0},r.definitions[a]||(r.definitions[a]=r.defsByOffset[s],r.definitionCount++),s=n}catch{break}}}function v(i,e,r,t,s,n){const f=i.chunkOffset+24,a=n??new D(e,r,t);let o="";try{o=a.parseDocument(i.binxmlBytes,f)}catch(u){o=`<!-- BinXml parse error: ${u instanceof Error?u.message:String(u)} -->
`,t.parseErrors.push({recordId:i.recordId,error:u instanceof Error?u.message:String(u)})}const c=y(o);return{xml:o,record:{recordId:i.recordId,timestamp:i.timestamp,xml:o,chunkIndex:s,...c,levelText:P[c.level]||`Level ${c.level}`}}}function j(i){const e=new DataView(i),r=V(i,e),t=Y(e,r.headerBlockSize),s={compiled:new Map,definitions:{},defsByOffset:{},definitionCount:0,references:[],referenceCount:0,missingRefs:[],missingCount:0,currentRecordId:0,parseErrors:[]};let n=0;const f=[],a=[],o=[];for(let d=0;d<t.length;d++){const S=t[d];s.defsByOffset={};const U=X(i,e,S),p=G(d,U.header,U.records);for(const I of p)f.push(I);const E=new DataView(i,S,65536);b(E,U.header,s);const g=new D(E,U.header,s);for(let I=0;I<U.records.length;I++){const N=U.records[I];s.currentRecordId=N.recordId;const{xml:m,record:W}=v(N,E,U.header,s,d,g);a.push(m),o.push(W)}n+=U.records.length}const c=[];c.push('<?xml version="1.0" encoding="utf-8"?>'),c.push(`<Events>
`);const u=c.join(`
`);return{summary:u,recordOutputs:a,records:o,xml:`${u}${a.join(`

`)}

</Events>`,totalRecords:n,numChunks:t.length,warnings:f,tplStats:s}}self.onmessage=i=>{const e=j(i.data);self.postMessage(e)}})();
